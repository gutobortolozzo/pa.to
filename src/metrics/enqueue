const publish = require('../queue/publish');
const subscribe = require('../queue/subscribe');
const queues = require('../queue/queues');
const access = require('./access');

module.exports = (key, request) => {

    const data = {
        key,
        userAgent : request.useragent,
        ip        : request.ip
    };

    publish(queues.access, data);
};

subscribe(queues.access, (data) => {

    if(process.env.NODE_ENV != 'production') return;

    const userAgentFields = access.userAgent(data.userAgent);

    return access.geoLocationAddress(data.ip)
        .then(geoLocation => {
            return access.accessed(data.key, userAgentFields, geoLocation);
        });
});